---
# ansible/verification_checks.yml

- name: VERIFY - Client was created in NetWorker
  networker_client_query:
    api_url: "http://{{ query_result.task_details.u_backup_server }}:8001"
    hostname: "{{ query_result.task_details.ci_fqdn }}"
  register: verify_networker_client

- name: ASSERT - NetWorker client exists
  assert:
    that:
      - "verify_networker_client.found"
    success_msg: "SUCCESS: Verified client '{{ query_result.task_details.ci_fqdn }}' exists in NetWorker."
    fail_msg: "FAILURE: Client '{{ query_result.task_details.ci_fqdn }}' was NOT found in NetWorker."

- name: VERIFY - Get final state of ServiceNow Task
  snow_task_get:
    api_url: "{{ snow_api_url }}"
    sys_id: "{{ query_result.task_details.sys_id }}"
  register: verify_snow_task

- name: ASSERT - ServiceNow task is closed correctly
  assert:
    that:
      - "verify_snow_task.found"
      - "verify_snow_task.task_details.state == '3'"
      - "'NetWorker client created successfully' in verify_snow_task.task_details.work_notes"
    success_msg: "SUCCESS: Verified task {{ query_result.task_details.number }} is Closed Complete."
    fail_msg: "FAILURE: Task {{ query_result.task_details.number }} was not closed correctly."